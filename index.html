<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airbnb con DeepSeek AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #FF5A5F;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fab fa-airbnb text-3xl text-[#FF5A5F] mr-2"></i>
                <span class="text-2xl font-bold text-[#FF5A5F]">airbnb</span>
            </div>
            <nav class="hidden md:flex space-x-6">
                <a href="#" class="text-gray-700 hover:text-[#FF5A5F]">Home</a>
                <a href="#" class="text-gray-700 hover:text-[#FF5A5F]">Preferiti</a>
                <a href="#" class="text-gray-700 hover:text-[#FF5A5F]">Viaggi</a>
                <a href="#" class="text-gray-700 hover:text-[#FF5A5F]">Messaggi</a>
                <a href="#" class="text-gray-700 hover:text-[#FF5A5F]">Profilo</a>
            </nav>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Side - AI Search -->
            <div class="lg:w-1/3">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">Cerca con DeepSeek AI</h2>
                    <p class="text-gray-600 mb-4">Descrivi dove vuoi andare e cosa stai cercando usando linguaggio naturale:</p>
                    
                    <div class="mb-4">
                        <textarea id="aiPrompt" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF5A5F]" rows="4" placeholder="Es: Cerco un appartamento tranquillo a Firenze vicino al centro per una coppia, con una bella vista e possibilmente con terrazza, budget massimo 150€ a notte per il prossimo weekend"></textarea>
                    </div>
                    
                    <button id="searchButton" class="w-full bg-[#FF5A5F] text-white py-3 rounded-lg font-semibold hover:bg-[#FF4449] transition">
                        <i class="fas fa-search mr-2"></i>Cerca con DeepSeek AI
                    </button>
                    
                    <div id="loading" class="loader hidden"></div>
                    
                    <div id="aiSuggestion" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                        <h3 class="font-bold mb-2">L'AI ha capito:</h3>
                        <div id="aiUnderstanding" class="text-gray-700"></div>
                    </div>
                </div>
            </div>
            
            <!-- Right Side - Results -->
            <div class="lg:w-2/3">
                <div id="resultsContainer" class="hidden">
                    <h2 class="text-2xl font-bold mb-6">Risultati della ricerca</h2>
                    
                    <div id="propertiesList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Properties will be added here dynamically -->
                    </div>
                </div>
                
                <div id="initialMessage" class="bg-white p-8 rounded-lg shadow-md text-center">
                    <i class="fas fa-home text-[#FF5A5F] text-5xl mb-4"></i>
                    <h2 class="text-2xl font-bold mb-3">Trova il tuo prossimo alloggio</h2>
                    <p class="text-gray-600">Usa l'intelligenza artificiale di DeepSeek per descrivere ciò che stai cercando e trova l'alloggio perfetto per te.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Conferma prenotazione</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="propertyDetails" class="mb-4">
                <!-- Property details will be added here -->
            </div>
            
            <div class="border-t border-gray-200 py-4 mb-4">
                <div class="flex justify-between mb-2">
                    <span>Prezzo per notte</span>
                    <span id="pricePerNight"></span>
                </div>
                <div class="flex justify-between mb-2">
                    <span>Tasse e pulizie</span>
                    <span id="taxes"></span>
                </div>
                <div class="flex justify-between font-bold">
                    <span>Totale</span>
                    <span id="totalPrice"></span>
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="font-bold mb-2">Scegli metodo di pagamento</h4>
                <div class="flex gap-3 mb-4">
                    <button id="paypalButton" class="flex-1 border border-gray-300 p-3 rounded-lg flex items-center justify-center bg-[#0070BA] text-white hover:bg-[#005ea6]">
                        <i class="fab fa-paypal mr-2"></i> PayPal
                    </button>
                    <button class="flex-1 border border-gray-300 p-3 rounded-lg flex items-center justify-center hover:bg-gray-50">
                        <i class="far fa-credit-card mr-2"></i> Carta
                    </button>
                </div>
            </div>
            
            <button id="confirmButton" class="w-full bg-[#FF5A5F] text-white py-3 rounded-lg font-semibold hover:bg-[#FF4449] transition">
                Conferma prenotazione
            </button>
        </div>
    </div>

    <script>
        // Mock data for demonstration purposes
        const mockProperties = [
            {
                id: 1,
                name: "Elegante appartamento nel centro di Firenze",
                description: "Splendido appartamento con vista sul Duomo, a pochi passi dai principali punti di interesse",
                price: 145,
                rating: 4.9,
                reviews: 127,
                location: "Centro storico, Firenze",
                image: "/api/placeholder/400/300",
                host: "Marco",
                features: ["2 ospiti", "1 camera da letto", "1 bagno", "Wi-Fi", "Cucina", "Terrazza"]
            },
            {
                id: 2,
                name: "Loft moderno vicino a Ponte Vecchio",
                description: "Loft completamente ristrutturato con vista sull'Arno, posizione ideale per esplorare la città",
                price: 135,
                rating: 4.7,
                reviews: 98,
                location: "Oltrarno, Firenze",
                image: "/api/placeholder/400/300",
                host: "Laura",
                features: ["2 ospiti", "Studio", "1 bagno", "Wi-Fi", "Cucina", "Aria condizionata"]
            },
            {
                id: 3,
                name: "Appartamento con terrazza panoramica",
                description: "Luminoso appartamento con terrazza privata e vista mozzafiato sulla città e le colline toscane",
                price: 150,
                rating: 4.8,
                reviews: 156,
                location: "San Niccolò, Firenze",
                image: "/api/placeholder/400/300",
                host: "Giulia",
                features: ["2 ospiti", "1 camera da letto", "1 bagno", "Wi-Fi", "Cucina", "Terrazza"]
            },
            {
                id: 4,
                name: "Accogliente studio nel Quartiere Santo Spirito",
                description: "Grazioso monolocale in zona tranquilla ma centrale, perfetto per coppie",
                price: 120,
                rating: 4.6,
                reviews: 89,
                location: "Santo Spirito, Firenze",
                image: "/api/placeholder/400/300",
                host: "Andrea",
                features: ["2 ospiti", "Studio", "1 bagno", "Wi-Fi", "Angolo cottura"]
            }
        ];

        // Function to call DeepSeek API
        async function callDeepSeekAPI(prompt) {
            const apiKey = 'sk-cdb69b2c6a314f9682df3e14b55dd740'; // DeepSeek API key
            const apiUrl = 'https://api.deepseek.com/v1/chat/completions';
            
            try {
                const response = await axios.post(
                    apiUrl,
                    {
                        model: "deepseek-chat",
                        messages: [
                            {
                                role: "system",
                                content: "Sei un assistente che aiuta a interpretare le richieste degli utenti per la ricerca di alloggi. Analizza la richiesta dell'utente ed estrai le informazioni rilevanti come: località, numero di ospiti, budget, date, e caratteristiche desiderate. Rispondi in formato JSON con i seguenti campi: 'understanding' (riepilogo della richiesta) e 'filters' (oggetto con i filtri estratti)."
                            },
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 500
                    },
                    {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        }
                    }
                );
                
                // Parse the response from DeepSeek
                const aiResponse = response.data.choices[0].message.content;
                
                // Try to parse JSON from the response
                try {
                    return JSON.parse(aiResponse);
                } catch (e) {
                    // If parsing fails, create a structured response from the text
                    return {
                        understanding: aiResponse,
                        filters: {
                            location: extractLocation(prompt),
                            guests: extractGuests(prompt),
                            maxPrice: extractPrice(prompt),
                            dates: extractDates(prompt),
                            amenities: extractAmenities(prompt)
                        }
                    };
                }
            } catch (error) {
                console.error('Error calling DeepSeek API:', error);
                
                // Fallback response in case of API error
                return {
                    understanding: `Ho analizzato la tua richiesta per: "${prompt.substring(0, 50)}${prompt.length > 50 ? '...' : ''}"`,
                    filters: {
                        location: extractLocation(prompt),
                        guests: extractGuests(prompt),
                        maxPrice: extractPrice(prompt),
                        dates: extractDates(prompt),
                        amenities: extractAmenities(prompt)
                    }
                };
            }
        }
        
        // Simple extraction functions as fallback
        function extractLocation(text) {
            const cities = ["firenze", "roma", "milano", "venezia", "napoli", "torino"];
            const textLower = text.toLowerCase();
            
            for (const city of cities) {
                if (textLower.includes(city)) {
                    return city.charAt(0).toUpperCase() + city.slice(1);
                }
            }
            
            return "Non specificata";
        }
        
        function extractGuests(text) {
            const textLower = text.toLowerCase();
            
            if (textLower.includes("coppia")) return 2;
            if (textLower.includes("famiglia")) return 4;
            if (textLower.includes("singolo") || textLower.includes("da solo")) return 1;
            
            return 2; // Default
        }
        
        function extractPrice(text) {
            const priceMatch = text.match(/(\d+)[\s]*[€$]|[€$][\s]*(\d+)/);
            return priceMatch ? parseInt(priceMatch[1] || priceMatch[2]) : 150;
        }
        
        function extractDates(text) {
            const months = ["gennaio", "febbraio", "marzo", "aprile", "maggio", "giugno", "luglio", "agosto", "settembre", "ottobre", "novembre", "dicembre"];
            
            if (text.toLowerCase().includes("weekend")) {
                const today = new Date();
                const nextFriday = new Date(today);
                nextFriday.setDate(today.getDate() + (5 - today.getDay() + 7) % 7);
                const nextSunday = new Date(nextFriday);
                nextSunday.setDate(nextFriday.getDate() + 2);
                
                return `${nextFriday.getDate()}-${nextSunday.getDate()} ${months[nextFriday.getMonth()]}`;
            }
            
            return "Date non specificate";
        }
        
        function extractAmenities(text) {
            const amenities = [];
            const textLower = text.toLowerCase();
            
            if (textLower.includes("vista")) amenities.push("vista");
            if (textLower.includes("terrazza")) amenities.push("terrazza");
            if (textLower.includes("piscina")) amenities.push("piscina");
            if (textLower.includes("wifi") || textLower.includes("wi-fi")) amenities.push("Wi-Fi");
            if (textLower.includes("cucina")) amenities.push("cucina");
            
            return amenities.length > 0 ? amenities : ["Non specificate"];
        }

        // Function to render properties
        function renderProperties(properties) {
            const propertiesList = document.getElementById('propertiesList');
            propertiesList.innerHTML = '';
            
            properties.forEach(property => {
                const propertyCard = document.createElement('div');
                propertyCard.className = 'property-card bg-white rounded-lg overflow-hidden shadow-md transition-transform duration-300';
                
                propertyCard.innerHTML = `
                    <img src="${property.image}" alt="${property.name}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm text-gray-600">${property.location}</span>
                            <div class="flex items-center">
                                <i class="fas fa-star text-yellow-500 mr-1"></i>
                                <span>${property.rating}</span>
                            </div>
                        </div>
                        <h3 class="font-bold mb-2">${property.name}</h3>
                        <p class="text-gray-600 text-sm mb-3 line-clamp-2">${property.description}</p>
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${property.features.map(feature => `
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded">${feature}</span>
                            `).join('')}
                        </div>
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-bold">${property.price}€</span>
                                <span class="text-gray-600"> / notte</span>
                            </div>
                            <button class="book-button bg-[#FF5A5F] text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-[#FF4449] transition" data-id="${property.id}">Prenota</button>
                        </div>
                    </div>
                `;
                
                propertiesList.appendChild(propertyCard);
            });
            
            // Add event listeners to book buttons
            document.querySelectorAll('.book-button').forEach(button => {
                button.addEventListener('click', function() {
                    const propertyId = this.getAttribute('data-id');
                    openPaymentModal(propertyId);
                });
            });
        }

        // Function to open payment modal
        function openPaymentModal(propertyId) {
            const property = mockProperties.find(p => p.id == propertyId);
            
            // Set property details in modal
            document.getElementById('propertyDetails').innerHTML = `
                <div class="flex items-center gap-4 mb-4">
                    <img src="${property.image}" alt="${property.name}" class="w-20 h-20 object-cover rounded-lg">
                    <div>
                        <h4 class="font-bold">${property.name}</h4>
                        <p class="text-sm text-gray-600">${property.location}</p>
                    </div>
                </div>
            `;
            
            // Set pricing
            const taxes = Math.round(property.price * 0.15);
            const total = property.price + taxes;
            
            document.getElementById('pricePerNight').textContent = `${property.price}€`;
            document.getElementById('taxes').textContent = `${taxes}€`;
            document.getElementById('totalPrice').textContent = `${total}€`;
            
            // Show modal
            document.getElementById('paymentModal').classList.remove('hidden');
        }

        // Main functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchButton = document.getElementById('searchButton');
            const aiPrompt = document.getElementById('aiPrompt');
            const loading = document.getElementById('loading');
            const aiSuggestion = document.getElementById('aiSuggestion');
            const aiUnderstanding = document.getElementById('aiUnderstanding');
            const resultsContainer = document.getElementById('resultsContainer');
            const initialMessage = document.getElementById('initialMessage');
            const closeModal = document.getElementById('closeModal');
            const paypalButton = document.getElementById('paypalButton');
            const confirmButton = document.getElementById('confirmButton');
            
            // Search button click handler
            searchButton.addEventListener('click', async function() {
                const prompt = aiPrompt.value.trim();
                
                if (!prompt) {
                    alert('Per favore, inserisci una descrizione della tua ricerca.');
                    return;
                }
                
                // Show loading
                loading.classList.remove('hidden');
                aiSuggestion.classList.add('hidden');
                initialMessage.classList.add('hidden');
                resultsContainer.classList.add('hidden');
                
                try {
                    // Call DeepSeek API
                    const response = await callDeepSeekAPI(prompt);
                    
                    // Show AI understanding
                    aiUnderstanding.textContent = response.understanding;
                    aiSuggestion.classList.remove('hidden');
                    
                    // Filter properties based on AI understanding
                    let filteredProperties = [...mockProperties];
                    
                    // Apply location filter if specified
                    if (response.filters && response.filters.location) {
                        const locationLower = response.filters.location.toLowerCase();
                        filteredProperties = filteredProperties.filter(property => 
                            property.location.toLowerCase().includes(locationLower)
                        );
                    }
                    
                    // Apply price filter if specified
                    if (response.filters && response.filters.maxPrice) {
                        filteredProperties = filteredProperties.filter(property => 
                            property.price <= response.filters.maxPrice
                        );
                    }
                    
                    // Apply amenities filter if specified
                    if (response.filters && response.filters.amenities && response.filters.amenities.length > 0) {
                        filteredProperties = filteredProperties.filter(property => {
                            return response.filters.amenities.some(amenity => 
                                property.features.some(feature => 
                                    feature.toLowerCase().includes(amenity.toLowerCase())
                                )
                            );
                        });
                    }
                    
                    // Show results - if filters eliminated all properties, show all as fallback
                    renderProperties(filteredProperties.length > 0 ? filteredProperties : mockProperties);
                    resultsContainer.classList.remove('hidden');
                } catch (error) {
                    console.error('Error:', error);
                    alert('Si è verificato un errore durante la ricerca. Riprova più tardi.');
                } finally {
                    // Hide loading
                    loading.classList.add('hidden');
                }
            });
            
            // Close modal handler
            closeModal.addEventListener('click', function() {
                document.getElementById('paymentModal').classList.add('hidden');
            });
            
            // PayPal button handler
            paypalButton.addEventListener('click', function() {
                alert('Stai per essere reindirizzato a PayPal per completare il pagamento...');
                // In a real application, this would redirect to PayPal checkout
            });
            
            // Confirm button handler
            confirmButton.addEventListener('click', function() {
                alert('Prenotazione confermata! Grazie per aver scelto Airbnb.');
                document.getElementById('paymentModal').classList.add('hidden');
            });
        });
    </script>
</body>
</html>
